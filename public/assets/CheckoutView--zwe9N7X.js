import{_ as R,n as q,u as A,k as B,c as d,b as a,F as V,l as M,t as l,e as D,w as i,y as P,D as L,a as c,v as k,E as g,B as z,g as T,h as I,f as $,m as w,s as U,r as v,q as G,o as n,d as J}from"./index-Dn0hYYMP.js";import{T as Z}from"./ToastNotification-C6JxJPdt.js";const H={class:"checkout-page"},K={class:"checkout-container"},O={class:"checkout-grid"},Q={class:"order-summary"},W={class:"item-info"},X={key:0},Y={class:"item-total"},ee={class:"order-total"},ae={class:"payment-section"},te={class:"payment-methods"},se=["disabled"],oe={key:0,class:"saved-cards"},re={class:"form-group"},le=["value"],de={key:0,class:"error-text"},ne={key:1,class:"new-card-form"},ue={class:"form-group"},ie={key:0,class:"error-text"},ce={class:"form-group"},ve={key:0,class:"error-text"},pe={class:"form-row"},_e={class:"form-group"},me={key:0,class:"error-text"},fe={class:"form-group"},he={key:0,class:"error-text"},ye={class:"form-group"},be={class:"checkbox-label"},xe={class:"form-actions"},ke=["disabled"],ge={__name:"CheckoutView",setup(we){const p=q();A();const h=$(),N=U(()=>p.items),C=U(()=>p.cartTotal),_=v([]),u=v("new_card"),y=v(null),r=v({card_number:"",card_holder_name:"",expiration_date:"",cvv:"",save_card:!1}),s=v({}),b=v(!1),m=v(null),f=v(""),S=async()=>{try{if(p.items.length>0)try{await w.post("/cart/sync",{items:p.items}),await new Promise(e=>setTimeout(e,500))}catch(e){console.error("Cart Sync Failed:",e)}const o=await w.get("/checkout");_.value=o.data.data.saved_cards||[],_.value.length>0&&(u.value="saved_card",y.value=_.value[0].id)}catch(o){console.error("Error fetching checkout data",o),o.response&&o.response.status===400&&(f.value="El carrito está vacío",m.value.show(),setTimeout(()=>h.push("/cart"),2e3))}};B(()=>{p.cartCount===0?h.push("/cart"):S()});const E=async()=>{b.value=!0,s.value={};const o={payment_method:u.value};u.value==="saved_card"?o.card_id=y.value:(o.card_number=r.value.card_number,o.card_holder_name=r.value.card_holder_name,o.expiration_date=r.value.expiration_date,o.cvv=r.value.cvv,o.save_card=r.value.save_card);try{const e=await w.post("/checkout",o);p.clearCart(),e.data&&e.data.data&&e.data.data.order_id?h.push(`/checkout/success/${e.data.data.order_id}`):(f.value="¡Pago realizado con éxito!",m.value.show(),setTimeout(()=>{h.push("/")},2e3))}catch(e){console.error("Payment failed",e),e.response&&e.response.data&&e.response.data.info?s.value=e.response.data.info:e.response&&e.response.data.message?(f.value=e.response.data.message,m.value.show()):(f.value="Error procesando el pago",m.value.show())}finally{b.value=!1}},x=o=>parseFloat(o).toFixed(2)+" €";return(o,e)=>{const F=G("RouterLink");return n(),d("div",H,[a("div",K,[e[20]||(e[20]=a("h1",null,"Finalizar Compra",-1)),a("div",O,[a("div",Q,[e[9]||(e[9]=a("h2",null,"Resumen del Pedido",-1)),(n(!0),d(V,null,M(N.value,(t,j)=>(n(),d("div",{key:j,class:"order-item"},[a("div",W,[a("h4",null,l(t.product.name),1),a("p",null,l(t.quantity)+" x "+l(x(t.product.final_price||t.product.price)),1),t.platform?(n(),d("small",X,"Plataforma: "+l(t.platform.name),1)):c("",!0)]),a("span",Y,l(x((t.product.final_price||t.product.price)*t.quantity)),1)]))),128)),a("div",ee,[e[8]||(e[8]=a("strong",null,"Total:",-1)),a("span",null,l(x(C.value)),1)])]),a("div",ae,[e[19]||(e[19]=a("h2",null,"Método de Pago",-1)),a("form",{onSubmit:D(E,["prevent"])},[a("div",te,[a("label",null,[i(a("input",{type:"radio",value:"saved_card","onUpdate:modelValue":e[0]||(e[0]=t=>u.value=t),disabled:_.value.length===0},null,8,se),[[P,u.value]]),e[10]||(e[10]=a("span",{class:"radio-label"},"Tarjeta guardada",-1))]),a("label",null,[i(a("input",{type:"radio",value:"new_card","onUpdate:modelValue":e[1]||(e[1]=t=>u.value=t)},null,512),[[P,u.value]]),e[11]||(e[11]=a("span",{class:"radio-label"},"Nueva tarjeta",-1))])]),u.value==="saved_card"?(n(),d("div",oe,[a("div",re,[e[12]||(e[12]=a("label",{for:"card_id"},"Selecciona tu tarjeta",-1)),i(a("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>y.value=t),id:"card_id",class:"form-select",required:""},[(n(!0),d(V,null,M(_.value,t=>(n(),d("option",{key:t.id,value:t.id},l(t.masked_card_number)+" - "+l(t.card_holder_name),9,le))),128))],512),[[L,y.value]]),s.value.card_id?(n(),d("span",de,l(s.value.card_id[0]),1)):c("",!0)])])):c("",!0),u.value==="new_card"?(n(),d("div",ne,[a("div",ue,[e[13]||(e[13]=a("label",{for:"card_number"},"Número de tarjeta *",-1)),i(a("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=t=>r.value.card_number=t),id:"card_number",class:g(["form-control",{"is-invalid":s.value.card_number}]),placeholder:"1234 5678 9012 3456"},null,2),[[k,r.value.card_number]]),s.value.card_number?(n(),d("span",ie,l(s.value.card_number[0]),1)):c("",!0)]),a("div",ce,[e[14]||(e[14]=a("label",{for:"card_holder_name"},"Titular de la tarjeta *",-1)),i(a("input",{type:"text","onUpdate:modelValue":e[4]||(e[4]=t=>r.value.card_holder_name=t),id:"card_holder_name",class:g(["form-control",{"is-invalid":s.value.card_holder_name}]),placeholder:"JUAN PÉREZ"},null,2),[[k,r.value.card_holder_name]]),s.value.card_holder_name?(n(),d("span",ve,l(s.value.card_holder_name[0]),1)):c("",!0)]),a("div",pe,[a("div",_e,[e[15]||(e[15]=a("label",{for:"expiration_date"},"Fecha de expiración *",-1)),i(a("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=t=>r.value.expiration_date=t),id:"expiration_date",class:g(["form-control",{"is-invalid":s.value.expiration_date}]),placeholder:"MM/AA"},null,2),[[k,r.value.expiration_date]]),s.value.expiration_date?(n(),d("span",me,l(s.value.expiration_date[0]),1)):c("",!0)]),a("div",fe,[e[16]||(e[16]=a("label",{for:"cvv"},"CVV *",-1)),i(a("input",{type:"text","onUpdate:modelValue":e[6]||(e[6]=t=>r.value.cvv=t),id:"cvv",class:g(["form-control",{"is-invalid":s.value.cvv}]),placeholder:"123"},null,2),[[k,r.value.cvv]]),s.value.cvv?(n(),d("span",he,l(s.value.cvv[0]),1)):c("",!0)])]),a("div",ye,[a("label",be,[i(a("input",{type:"checkbox","onUpdate:modelValue":e[7]||(e[7]=t=>r.value.save_card=t)},null,512),[[z,r.value.save_card]]),e[17]||(e[17]=a("span",null,"Guardar tarjeta para futuras compras",-1))])])])):c("",!0),a("div",xe,[T(F,{to:"/cart",class:"btn-secondary"},{default:I(()=>[...e[18]||(e[18]=[J("Volver al carrito",-1)])]),_:1}),a("button",{type:"submit",class:"btn-primary",disabled:b.value},l(b.value?"Procesando...":`Pagar ${x(C.value)}`),9,ke)])],32)])])]),T(Z,{ref_key:"toast",ref:m,message:f.value},null,8,["message"])])}}},Me=R(ge,[["__scopeId","data-v-32a0d609"]]);export{Me as default};
